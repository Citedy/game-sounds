#!/usr/bin/env bash
# game-sounds — CLI for managing game sound packs in Claude Code
# Usage: game-sounds [command] [args]

set -euo pipefail

# Find config file
find_config() {
  # 1. Script's own plugin directory
  local script_dir="$(cd "$(dirname "$0")/.." && pwd)"
  [[ -f "$script_dir/config.json" ]] && echo "$script_dir/config.json" && return 0
  # 2. Marketplace cache
  for f in "$HOME"/.claude/plugins/cache/citedy/game-sounds/*/config.json; do
    [[ -f "$f" ]] && echo "$f" && return 0
  done
  # 3. Manual clone location
  [[ -f "$HOME/.claude/plugins/game-sounds/config.json" ]] && echo "$HOME/.claude/plugins/game-sounds/config.json" && return 0
  echo "Error: config.json not found" >&2
  return 1
}

# Find sounds root
find_sounds() {
  local config="$1"
  echo "$(dirname "$config")/sounds"
}

CONFIG=$(find_config)
SOUNDS_DIR=$(find_sounds "$CONFIG")

read_config() {
  python3 -c "import json; c=json.load(open('$CONFIG')); print(c.get('$1', '$2'))" 2>/dev/null
}

write_config() {
  python3 -c "
import json
with open('$CONFIG') as f:
    c = json.load(f)
c['$1'] = $2
with open('$CONFIG', 'w') as f:
    json.dump(c, f, indent=2)
    f.write('\n')
" 2>/dev/null
}

case "${1:-help}" in
  switch|pack|p)
    if [[ -z "${2:-}" ]]; then
      # Interactive selection
      echo "Available packs:"
      echo ""
      i=1
      packs=()
      current=$(read_config active_pack warcraft)
      for dir in "$SOUNDS_DIR"/*/; do
        pack=$(basename "$dir")
        count=$(find "$dir" -name "*.mp3" 2>/dev/null | wc -l | tr -d ' ')
        marker=""
        [[ "$pack" == "$current" ]] && marker=" (active)"
        echo "  $i) $pack ($count sounds)$marker"
        packs+=("$pack")
        i=$((i + 1))
      done
      echo ""
      read -p "Select pack [1-${#packs[@]}]: " choice
      if [[ "$choice" =~ ^[0-9]+$ ]] && (( choice >= 1 && choice <= ${#packs[@]} )); then
        selected="${packs[$((choice - 1))]}"
        write_config active_pack "\"$selected\""
        echo "Switched to: $selected"
      else
        echo "Invalid choice"
        exit 1
      fi
    else
      pack="$2"
      if [[ -d "$SOUNDS_DIR/$pack" ]]; then
        write_config active_pack "\"$pack\""
        echo "Switched to: $pack"
      else
        echo "Pack '$pack' not found. Available:"
        ls -1 "$SOUNDS_DIR"
        exit 1
      fi
    fi
    ;;

  list|ls|l)
    current=$(read_config active_pack warcraft)
    echo "Sound packs:"
    echo ""
    for dir in "$SOUNDS_DIR"/*/; do
      pack=$(basename "$dir")
      count=$(find "$dir" -name "*.mp3" 2>/dev/null | wc -l | tr -d ' ')
      marker=""
      [[ "$pack" == "$current" ]] && marker=" *"
      echo "  $pack ($count sounds)$marker"
    done
    echo ""
    echo "* = active pack"
    ;;

  volume|vol|v)
    if [[ -z "${2:-}" ]]; then
      vol=$(read_config volume 0.5)
      echo "Volume: $vol"
    else
      vol="$2"
      write_config volume "$vol"
      echo "Volume set to: $vol"
    fi
    ;;

  test|t)
    category="${2:-session-start}"
    plugin_root="$(dirname "$CONFIG")"
    CLAUDE_PLUGIN_ROOT="$plugin_root" bash "$plugin_root/scripts/play-sound.sh" "$category"
    echo "Played: $category"
    ;;

  status|s)
    pack=$(read_config active_pack warcraft)
    vol=$(read_config volume 0.5)
    count=$(find "$SOUNDS_DIR/$pack" -name "*.mp3" 2>/dev/null | wc -l | tr -d ' ')
    echo "Pack:   $pack ($count sounds)"
    echo "Volume: $vol"
    ;;

  help|--help|-h|*)
    cat <<'HELP'
game-sounds — manage Claude Code game sound packs

Commands:
  switch [pack]    Switch sound pack (interactive if no pack given)
  list             List available packs
  volume [0.0-1.0] Get/set volume
  test [category]  Play a test sound
  status           Show current config

Examples:
  game-sounds switch starcraft
  game-sounds switch              # interactive picker
  game-sounds volume 0.3
  game-sounds test task-complete
  game-sounds list
HELP
    ;;
esac
